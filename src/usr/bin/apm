#!/bin/bash
VERSION=1.1.3
# è·å–è„šæœ¬åç§°ç”¨äºå¸®åŠ©ä¿¡æ¯
SCRIPT_NAME=$(basename "$0")
PATH_PREFIX=/var/lib/apm/apm/files/ace-env/

log.warn() { echo -e "[\e[33mWARN\e[0m]:  \e[1m$*\e[0m"; }
log.error()  { echo -e "[\e[31mERROR\e[0m]: \e[1m$*\e[0m"; }
log.info() { echo -e "[\e[96mINFO\e[0m]:  \e[1m$*\e[0m"; }
log.debug()  { echo -e "[\e[32mDEBUG\e[0m]: \e[1m$*\e[0m"; }

# å¸®åŠ©ä¿¡æ¯å‡½æ•°
show_help() {
    cat <<EOF
APM - Amber Package Manager ${VERSION}

Usage:
  $SCRIPT_NAME [COMMAND] [OPTIONS] [PACKAGES...]


Commands:
  install           å®‰è£…è½¯ä»¶åŒ…
  remove            å¸è½½è½¯ä»¶åŒ…
  run <package>     è¿è¡ŒæŒ‡å®šè½¯ä»¶åŒ…çš„å¯æ‰§è¡Œæ–‡ä»¶
  sandbox-run <package> è¿è¡ŒæŒ‡å®šè½¯ä»¶åŒ…çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸»ç›®å½•æ²™ç®±åŒ–ï¼‰
  bwrap-run <package> è¿è¡ŒæŒ‡å®šè½¯ä»¶åŒ…çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä½¿ç”¨ç‰¹æ®Šçš„æŒ‚è½½å‚æ•°ä»¥æ”¯æŒbwrapï¼‰

  update            æ›´æ–°è½¯ä»¶åŒ…ä¿¡æ¯
  hold              é”å®šè½¯ä»¶åŒ…ç‰ˆæœ¬
  unhold            è§£é”è½¯ä»¶åŒ…ç‰ˆæœ¬
  full-upgrade      å‡çº§å…¨éƒ¨è½¯ä»¶åŒ…
  list              æŸ¥çœ‹å¯ç”¨è½¯ä»¶åŒ…ä¿¡æ¯
  search            æœç´¢è½¯ä»¶åŒ…

  download          ä¸‹è½½åŒ…
  show              å±•ç¤ºåŒ…ä¿¡æ¯
  clean             æ¸…é™¤ç¼“å­˜è½¯ä»¶åŒ…
  autoremove        è‡ªåŠ¨ç§»é™¤ä¸éœ€è¦çš„åŒ…
  ssaudit <path>    ä½¿ç”¨ ssaudit è¿›è¡Œæœ¬åœ°è½¯ä»¶å®‰è£…ï¼Œè¯¦æƒ…è§ spark-store
  debug             æ˜¾ç¤ºè°ƒè¯•ç³»ç»Ÿä¿¡æ¯å¹¶è¿›å…¥è°ƒè¯•ç¯å¢ƒ

  amber             å½©è›‹åŠŸèƒ½
  xmp360            å½©è›‹åŠŸèƒ½
  bronya            å½©è›‹åŠŸèƒ½

  -h, --help        æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
  -v, --version     å±•ç¤ºAPMç‰ˆæœ¬å·

EOF
}


apm_exec(){
    # é€’å½’è¯»å–infoæ–‡ä»¶å¹¶æ„å»ºlowerdir
    local lowerdirs=()
    local current_dir="${PATH_PREFIX}/var/lib/apm/${coredir}"  # å½“å‰ç›®å½•å¼€å§‹
    local next_info_file=""
    
    # ä½¿ç”¨ç»Ÿä¸€çš„ ace-run è„šæœ¬
    APM_RUN_EXEC=/var/lib/apm/apm/files/ace-run
    
    while : ; do
        # æ„å»ºinfoæ–‡ä»¶çš„è·¯å¾„
        next_info_file="${current_dir}/info"
#        echo "${current_dir}/info"
        # æ£€æŸ¥infoæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [[ ! -f "$next_info_file" ]]; then
#            log.debug "No more info files found, stopping recursion."
            break
        fi
        
        # è¯»å–infoæ–‡ä»¶çš„æ¯ä¸€è¡Œå¹¶æ„å»ºlowerdir
        while IFS= read -r basedir; do
            [[ -z "$basedir" ]] && continue  # è·³è¿‡ç©ºè¡Œ

            # æ£€æŸ¥ace-envç›®å½•æ˜¯å¦å­˜åœ¨
            if [[ -d "${PATH_PREFIX}/var/lib/apm/${basedir}/files/ace-env" ]]; then
                lowerdirs+=("${PATH_PREFIX}/var/lib/apm/${basedir}/files/ace-env")
            # å¦‚æœace-envä¸å­˜åœ¨ï¼Œæ£€æŸ¥coreç›®å½•
            elif [[ -d "${PATH_PREFIX}/var/lib/apm/${basedir}/files/core" ]]; then
                lowerdirs+=("${PATH_PREFIX}/var/lib/apm/${basedir}/files/core")
            else
                log.warn "Neither ace-env nor core directory found for base: $basedir"
            fi
        done < "$next_info_file"

        # å°è¯•è·å–ä¸‹ä¸€ä¸ªä¾èµ–ä¿¡æ¯çš„è·¯å¾„
        local next_basedir=$(tail -n 1 "$next_info_file")
        if [[ -z "$next_basedir" || ! -d "${PATH_PREFIX}/var/lib/apm/${next_basedir}" ]]; then
            log.debug "No further dependencies found, ending recursion."
            break
        fi
        # æ›´æ–°å½“å‰ç›®å½•ï¼Œé€’å½’å¤„ç†ä¸‹ä¸€ä¸ªä¾èµ–
        current_dir="${PATH_PREFIX}/var/lib/apm/${next_basedir}"
    done
    
    # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†æœ‰æ•ˆçš„lowerdir
    if [[ ${#lowerdirs[@]} -eq 0 ]]; then
        log.error "No valid lower directories found for package: $coredir"
        return 1
    fi
    
    # å°†lowerdirsæ•°ç»„ç”¨å†’å·è¿æ¥èµ·æ¥
    local lowerdir=$(IFS=:; echo "${lowerdirs[*]}")
    # åˆ›å»ºæŒ‚è½½ç‚¹ç›®å½•
    mkdir -p "/tmp/apm/${coredir}"
    
    # ä½¿ç”¨fuse-overlayfsæŒ‚è½½
    log.debug "Mounting with lowerdir: $lowerdir"
    fuse-overlayfs -o lowerdir="$lowerdir",upperdir="${PATH_PREFIX}/var/lib/apm/${coredir}/files/core/",workdir="${PATH_PREFIX}/var/lib/apm/${coredir}/files/work/" "/tmp/apm/${coredir}"
    
    # æ‰§è¡Œå‘½ä»¤
    chrootEnvPath="/tmp/apm/${coredir}" ${APM_RUN_EXEC} "$@"
    
    # å¸è½½
    umount "/tmp/apm/${coredir}"
}




# è°ƒè¯•ä¿¡æ¯å‡½æ•°
debug_info() {
    log.debug "======= APM Debug Information ======="
    log.debug "User: $(whoami)"
    log.debug "Hostname: $(hostname)"
    log.debug "OS: $(lsb_release -ds 2>/dev/null || uname -om)"
    log.debug "Kernel: $(uname -sr)"
    log.debug "Bash Version: ${BASH_VERSION}"
    log.debug "APT Version: $(apt --version | head -n1)"
    log.debug "APM APT Version: $(amber-pm-debug apt --version | head -n1)"
    log.debug "====================================="

amber-pm-debug "$@"

}

# å½©è›‹å‡½æ•°
amber_egg() {
    cat <<'EOF'

    ____                            ____                         
   / __ )____ __________  ____     / __ )__  ______  ____  __  __
  / __  / __ `/ ___/ __ \/ __ \   / __  / / / / __ \/ __ \/ / / /
 / /_/ / /_/ / /  / /_/ / / / /  / /_/ / /_/ / / / / / / / /_/ / 
/_____/\__,_/_/   \____/_/ /_/  /_____/\__,_/_/ /_/_/ /_/\__, /  
                                                        /____/   

Amber Package Manager - Sparkling with magic! å®‰æŸåŒ…ç®¡ç†å™¨ - blingblingï½
ğŸ’ Another target tracked down by Outrider Amber! ä¾¦å¯Ÿéª‘å£«ï¼Œå‘ç°ç›®æ ‡ï¼
EOF
}

bronya_egg() {
    cat <<'EOF'
  _   __     ____            _       ____         __              
 | | / /__ _/ / /____ ______(_)__   / __/_ _____ / /____ __ _     
 | |/ / _ `/ /  '_/ // / __/ / -_) _\ \/ // (_-</ __/ -_)  ' \    
 |___/\_,_/_/_/\_\\_, /_/ /_/\__/ /___/\_, /___/\__/\__/_/_/_/    
  / /  ___ ___ __/___/____/ /         /___/                       
 / /__/ _ `/ // / _ \/ __/ _ \                                    
/____/\_,_/\_,_/_//_/\__/_//_/        

Valkyrie ç³»ç»Ÿå¯åŠ¨ - é‡è£…å°å…”ï¼ŒFireï¼
ğŸ’ æ„Ÿè°¢ Anysets ä¸º AmberCE å’Œ AmberPM çš„ Arch æ¶æ„æ”¯æŒæä¾›å¸®åŠ©ï½
EOF
}

xmp360_egg() {
    cat <<'EOF'
################################################################################
################################################################################
################################################################################
#####################                                       ####################
####################.                                       %###################
##########=                                                 ####################
############################                                #=========*#########
#############                                              .%   .*****=  :######
###############################                            =+   =#######* -#####
#####                                                      %:   *######## :#####
######################%                                    #    ########* +#####
########:                                                  #              %#####
##########################                                .#              ######
##################*                                       -*              ######
##################=        =###%:                         +-    *###*     ######
##################.      #       %:                          :*       #  -######
##################.     %  *###=  %                         --  ####   % %######
########################-  ####+  ###########################  .####.  #########
#########################        ############################%        ##########
###########################=::+################################%-:-*############
################################################################################

å“‡â€”â€”â€”â€”â€”â€”è¢„ - æ’å¤§è¿å’¯ï¼
ğŸ’ æ„Ÿè°¢ æ½‡æ¹˜Â·ç§€ ä¸º APM çš„ RPM æ¶æ„æ”¯æŒæä¾›å¸®åŠ©ï½
EOF
}

apm-nvidia-toggle(){

# APM åŸºç¡€è·¯å¾„
APM_BASE="${PATH_PREFIX}/var/lib/apm"

# æ£€æŸ¥åŸºç¡€ç›®å½•æ˜¯å¦å­˜åœ¨
if [[ ! -d "$APM_BASE" ]]; then
    echo "é”™è¯¯: ç›®å½• $APM_BASE ä¸å­˜åœ¨"
    exit 1
fi

# éå† /var/lib/apm ä¸‹çš„æ‰€æœ‰ç›®å½•
for dir in "$APM_BASE"/*/; do
    # ç§»é™¤æœ«å°¾çš„æ–œæ å¾—åˆ°çº¯ç›®å½•å
    dir="${dir%/}"
    
    # æå–ç›®å½•åï¼ˆä¸åŒ…æ‹¬å®Œæ•´è·¯å¾„ï¼‰
    dirname=$(basename "$dir")
    # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    target_file="${APM_BASE}/${dirname}/files/ace-env"
    if [[ -e "$target_file" ]]; then
        
        # å°†ç›®å½•ä¼ é€’ç»™ amber-pm-configure-nvidia
        amber-pm-configure-nvidia "$target_file"
        

    fi
done
}
# ä¸»å‘½ä»¤å¤„ç†
case "$1" in
    install|full-upgrade|upgrade|reinstall)
    command=$1
    shift
    amber-pm-debug aptss "$command" "$@"
        exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log.info "Operation successful"
    else
        log.error "Error: Operation failed"
        exit $exit_code
    fi
    amber-pm-debug amber-pm-dstore-patch
    apm-nvidia-toggle
    amber-pm-gxde-desktop-fix
    ;;
    download|search|policy|list|update|clean|show|depends|rdepends|changelog|moo)
    command=$1
    shift
    amber-pm-debug aptss "$command" "$@"
        exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log.info "Operation successful"
    else
        log.error "Error: Operation failed"
        exit $exit_code
    fi
    ;;
    hold|unhold)
    command=$1
    shift
    amber-pm-debug apt-mark "$command" "$@"
        exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log.info "Operation successful"
    else
        log.error "Error: Operation failed"
        exit $exit_code
    fi
    ;;

   remove|autoremove|purge|autopurge)
        # ç‰¹æ®ŠAPTå‘½ä»¤ï¼šç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•°åä¼ é€’å…¶ä½™å‚æ•°
        command=$1
        shift
        amber-pm-debug aptss "$command" "$@"
        exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log.info "Operation successful"
    else
        log.error "Error: Operation failed"
        exit $exit_code
    fi
        amber-pm-debug amber-pm-dstore-patch
        amber-pm-gxde-desktop-fix
        ;;
   run)
        # è¿è¡ŒåŒ…å‘½ä»¤ï¼šç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯åŒ…å
        if [ -z "$2" ]; then
            log.error "Package name required for 'run' command"
            show_help
            exit 1
        fi
        
        # æ£€æŸ¥åŒ…æ˜¯å¦å·²å®‰è£…
        pkg="$2"
        shift 2  # ç§»é™¤ 'run' å’ŒåŒ…å
        
        if ! ls "${PATH_PREFIX}/var/lib/apm/$pkg" >/dev/null 2>&1; then
        # å¦‚æœå¸¦å‰ç¼€çš„ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•ä¸å¸¦å‰ç¼€çš„ç›®å½•
            if ls "/var/lib/apm/$pkg" >/dev/null 2>&1; then
                # å¦‚æœä¸å¸¦å‰ç¼€çš„ç›®å½•å­˜åœ¨ï¼Œæ¸…ç©º PATH_PREFIX
                PATH_PREFIX=""
            else
                # å¦‚æœä¸¤ä¸ªç›®å½•éƒ½ä¸å­˜åœ¨ï¼ŒæŠ¥é”™é€€å‡º
                log.error "Package not installed: $pkg"
                exit 1
            fi
        fi
        
        coredir=$pkg
        export APM_PKG_NAME=$pkg

        # æ£€æµ‹æ˜¯å¦æœ‰é¢å¤–å‘½ä»¤å‚æ•°
        if [ $# -gt 0 ]; then
            # æœ‰é¢å¤–å‚æ•°ï¼šæ‰§è¡Œç”¨æˆ·æä¾›çš„å‘½ä»¤
            log.info "Running user command: $*"
            apm_exec "$@"
        else
            # æ²¡æœ‰é¢å¤–å‚æ•°ï¼šæç¤º
            log.info "Usage: $SCRIPT_NAME run $pkg [EXEC_PATH]"
            exit 1
        fi
        ;;
   sandbox-run)
        # è¿è¡ŒåŒ…å‘½ä»¤ï¼šç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯åŒ…å
        export APM_USE_SANDBOX=1
        shift
        $0 run "$@"
        ;;
   bwrap-run)
        # è¿è¡ŒåŒ…å‘½ä»¤ï¼šä½¿ç”¨ç‰¹æ®Šçš„æŒ‚è½½å‚æ•°ä»¥æ”¯æŒbwrap
        export APM_USE_BWRAP=1
        shift
        $0 run "$@"
        ;;
    debug)
        shift
        debug_info $@
        ;;
    ssaudit)
        amber-pm-debug ssaudit $@ --native
        exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log.info "Operation successful"
    else
        log.error "Error: Operation failed"
        exit $exit_code
    fi
        amber-pm-debug amber-pm-dstore-patch
        amber-pm-gxde-desktop-fix

        ;;
    -h|--help)
        show_help
        ;;
    -v|--version)
        echo "$VERSION"
        ;;
    amber)
        amber_egg
        ;;
    xmp360)
        xmp360_egg
        ;;
    bronya)
        bronya_egg
        ;;
    *)
        show_help
        ;;
esac